# 10. Cronjobs and Custom Commands

## Overview

The Fucking File Hosting application includes a comprehensive set of custom Artisan commands and automated cronjobs for maintenance, monitoring, and optimization. This system ensures optimal performance and automatic cleanup of expired files and temporary data.

## üïê Automated Cronjobs (Laravel Scheduler)

### Setting Up the Master Cron Job

Add this **single cron job** to your server to enable all automated tasks:

```bash
* * * * * cd /path/to/your/project && php artisan schedule:run >> /dev/null 2>&1
```

### Scheduled Tasks

The application automatically runs these tasks based on the schedule defined in `app/Console/Kernel.php`:

#### Hourly Tasks
- **Performance Monitoring** (`filehosting:monitor --cleanup`)
  - Monitors server performance and resource usage
  - Cleans up expired sessions automatically
  - Runs every hour without overlapping

#### Every 4 Hours
- **Light Optimization** (`filehosting:optimize`)
  - Basic performance optimization
  - Memory cleanup and cache clearing
  - Database query optimization

#### Every 6 Hours
- **Session Cleanup** (`upload:cleanup-sessions`)
  - Removes expired upload sessions
  - Cleans up associated temporary chunks
  - Prevents session table bloat

#### Daily Tasks
- **Expired Files Cleanup** (`files:cleanup --force`)
  - Removes expired files from storage and database
  - Runs daily at 2:00 AM
  - Frees up disk space automatically

#### Twice Daily
- **Temporary Files Cleanup** (`upload:cleanup-temp --force`)
  - Cleans up temporary chunks and failed uploads
  - Runs at 2:00 AM and 2:00 PM
  - Removes orphaned files

#### Daily Aggressive Optimization
- **Aggressive Optimization** (`filehosting:optimize --aggressive`)
  - Deep system optimization during low traffic
  - Runs daily at 3:00 AM
  - Database optimization and memory cleanup

#### Weekly Tasks
- **Comprehensive Cleanup** (`upload:cleanup-all --force`)
  - Complete system cleanup
  - Runs every Sunday at 3:00 AM
  - Combines all cleanup operations

## üõ†Ô∏è Custom Artisan Commands

### File Management Commands

#### `files:cleanup`
Clean up expired files from storage and database.

**Usage:**
```bash
# Basic cleanup with confirmation
php artisan files:cleanup

# Force cleanup without confirmation
php artisan files:cleanup --force

# Dry run to see what would be deleted
php artisan files:cleanup --dry-run
```

**Options:**
- `--dry-run`: Show what would be deleted without actually deleting
- `--force`: Force cleanup without confirmation

**Features:**
- Removes expired files from both storage and database
- Displays detailed cleanup statistics
- Shows freed storage space
- Progress bar for large cleanup operations

#### `upload:cleanup-temp`
Clean up temporary chunks, failed uploads, and orphaned files.

**Usage:**
```bash
# Clean all temporary files
php artisan upload:cleanup-temp --force

# Clean only specific types
php artisan upload:cleanup-temp --chunks
php artisan upload:cleanup-temp --failed
php artisan upload:cleanup-temp --orphaned
php artisan upload:cleanup-temp --empty-dirs

# Dry run
php artisan upload:cleanup-temp --dry-run
```

**Options:**
- `--dry-run`: Show what would be deleted
- `--force`: Force cleanup without confirmation
- `--chunks`: Only clean up temporary chunks
- `--failed`: Only clean up failed uploads
- `--orphaned`: Only clean up orphaned files
- `--empty-dirs`: Only clean up empty directories

#### `upload:cleanup-sessions`
Clean up expired upload sessions.

**Usage:**
```bash
php artisan upload:cleanup-sessions
```

**Features:**
- Removes expired chunked upload sessions
- Cleans up associated temporary files
- Prevents session table bloat

#### `upload:cleanup-all`
Comprehensive cleanup of all temporary and expired data.

**Usage:**
```bash
# Complete system cleanup
php artisan upload:cleanup-all --force

# Dry run to see what would be cleaned
php artisan upload:cleanup-all --dry-run
```

**Features:**
- Combines all cleanup operations
- Runs expired files, sessions, and temp cleanup
- Provides comprehensive cleanup statistics
- Ideal for weekly maintenance

### Performance and Monitoring Commands

#### `filehosting:monitor`
Monitor file hosting performance and resource usage.

**Usage:**
```bash
# Basic monitoring
php artisan filehosting:monitor

# Monitor with automatic cleanup
php artisan filehosting:monitor --cleanup
```

**Features:**
- Server load metrics and resource usage
- File and session statistics
- Performance recommendations
- Automatic cleanup of expired sessions
- Optimal settings suggestions for your hosting environment

**Output Example:**
```
=== File Hosting Performance Monitor ===

--- Server Load Metrics ---
Active Upload Sessions: 3
Memory Usage: 45%
Disk Usage: 67%
Server Load Score: 32/100
Recommended Chunk Size: 2.00 MB
Server Status: HEALTHY

--- Resource Usage ---
Memory: 1.8 GB / 4.0 GB (45%)
Peak Memory: 2.1 GB (52%)
Execution Time: 150ms
Disk: 67.3 GB / 100 GB (67%)

--- File Statistics ---
Total Files: 15,432
Total Size: 45.2 GB
Expired Files: 234
Files (24h): 89
Average File Size: 3.1 MB

--- Recommendations ---
‚úì System is running optimally
```

#### `filehosting:optimize`
Optimize file hosting for high user load.

**Usage:**
```bash
# Basic optimization
php artisan filehosting:optimize

# Aggressive optimization (use during low traffic)
php artisan filehosting:optimize --aggressive

# Dry run to see what would be done
php artisan filehosting:optimize --dry-run
```

**Options:**
- `--aggressive`: Use aggressive optimization (deletes large old files)
- `--dry-run`: Show what would be done without executing

**Features:**
- Upload session optimization
- File storage cleanup
- Database optimization
- Memory usage optimization
- Generates detailed optimization report
- Provides hosting-specific recommendations

### Maintenance Commands

#### `maintenance`
Manage maintenance mode for the application.

**Usage:**
```bash
# Enable maintenance mode
php artisan maintenance enable

# Enable with custom message
php artisan maintenance enable --message="Upgrading to make things even more fucking awesome!"

# Disable maintenance mode
php artisan maintenance disable

# Check maintenance status
php artisan maintenance status
```

**Features:**
- Custom maintenance messages
- Environment variable management
- Status checking
- Graceful maintenance mode handling

### Utility Commands

#### `filehosting:permissions`
Set up secure file permissions for the application.

**Usage:**
```bash
php artisan filehosting:permissions
```

**Features:**
- Sets proper file and directory permissions
- Secures storage directories
- Configures web server access
- Prevents unauthorized file access

#### `filehosting:config`
Display current chunk configuration and settings.

**Usage:**
```bash
php artisan filehosting:config
```

**Features:**
- Shows current chunk size settings
- Displays upload limits
- Shows storage configuration
- Provides configuration recommendations

#### `filehosting:recover`
Recover failed upload sessions and chunks.

**Usage:**
```bash
php artisan filehosting:recover {session_id}
```

**Features:**
- Attempts to recover failed uploads
- Reconstructs files from chunks
- Validates file integrity
- Updates database records

#### `filehosting:nuclear-reset`
**‚ö†Ô∏è DANGEROUS COMMAND** - Complete system reset.

**Usage:**
```bash
php artisan filehosting:nuclear-reset --confirm
```

**Features:**
- Deletes ALL files and data
- Resets database
- Clears all caches
- **USE WITH EXTREME CAUTION**

## üìä Monitoring and Performance

### Resource Monitoring

The monitoring system tracks:

- **Server Load**: CPU usage and system load
- **Memory Usage**: Current, peak, and percentage usage
- **Disk Usage**: Storage consumption and available space
- **Active Sessions**: Current upload sessions
- **File Statistics**: Total files, sizes, and growth rates

### Performance Optimization

The optimization system provides:

- **Automatic Cleanup**: Removes expired and temporary files
- **Database Optimization**: Optimizes tables and clears caches
- **Memory Management**: Garbage collection and cache clearing
- **Load Balancing**: Adjusts settings based on current load

### Hosting-Specific Recommendations

The system provides tailored recommendations for your hosting environment:

- **Chunk Size**: Optimal chunk size based on memory limits
- **Concurrent Uploads**: Maximum safe concurrent uploads
- **Cleanup Frequency**: How often to run cleanup based on usage
- **File Retention**: Optimal retention periods based on storage limits

## üîß Configuration

### Environment Variables

Configure cronjob behavior with these environment variables:

```env
# Cleanup Configuration
CLEANUP_TEMP_CHUNKS_ENABLED=true
CLEANUP_TEMP_CHUNKS_AGE_HOURS=24
CLEANUP_FAILED_UPLOADS_ENABLED=true
CLEANUP_FAILED_UPLOADS_AGE_HOURS=72
CLEANUP_ORPHANED_FILES_ENABLED=true
CLEANUP_EMPTY_DIRECTORIES_ENABLED=true

# Performance Monitoring
PERFORMANCE_MONITORING_ENABLED=true
RESOURCE_MONITORING_ENABLED=true
OPTIMIZATION_ENABLED=true

# Maintenance Mode
MAINTENANCE_MODE_ENABLED=false
MAINTENANCE_MESSAGE="We're making improvements. Be back soon!"
```

### Customizing Schedules

Edit `app/Console/Kernel.php` to customize the schedule:

```php
protected function schedule(Schedule $schedule): void
{
    // Custom schedule example
    $schedule->command('files:cleanup --force')
             ->dailyAt('01:00') // Run at 1 AM instead of 2 AM
             ->withoutOverlapping()
             ->runInBackground();
    
    // Add custom frequency
    $schedule->command('filehosting:monitor')
             ->everyFifteenMinutes() // More frequent monitoring
             ->withoutOverlapping();
}
```

## üö® Emergency Commands

### Quick System Recovery

```bash
# Emergency cleanup (frees maximum space)
php artisan upload:cleanup-all --force
php artisan filehosting:optimize --aggressive

# System health check
php artisan filehosting:monitor

# Reset maintenance mode if stuck
php artisan maintenance disable
```

### Troubleshooting Commands

```bash
# Check system status
php artisan about

# Clear all caches
php artisan optimize:clear

# Check scheduled tasks
php artisan schedule:list

# Test scheduler
php artisan schedule:test
```

## üìà Best Practices

### Cronjob Management

1. **Monitor Logs**: Regularly check cronjob execution logs
2. **Test Schedules**: Use `--dry-run` options to test commands
3. **Backup Before Cleanup**: Always backup before aggressive cleanup
4. **Monitor Resources**: Watch system resources during cleanup

### Performance Optimization

1. **Run During Low Traffic**: Schedule heavy operations during off-peak hours
2. **Use Background Processing**: Enable `runInBackground()` for long-running tasks
3. **Prevent Overlapping**: Use `withoutOverlapping()` to prevent conflicts
4. **Monitor Results**: Check optimization reports regularly

### Maintenance Planning

1. **Schedule Maintenance**: Plan maintenance windows in advance
2. **Notify Users**: Use custom maintenance messages
3. **Test Recovery**: Regularly test backup and recovery procedures
4. **Document Changes**: Keep track of configuration changes

## üîç Troubleshooting

### Common Issues

**Cronjobs Not Running**
```bash
# Check if cron service is running
systemctl status cron

# Verify crontab entry
crontab -l

# Test scheduler manually
php artisan schedule:run
```

**High Resource Usage**
```bash
# Check current load
php artisan filehosting:monitor

# Run optimization
php artisan filehosting:optimize --aggressive

# Check for stuck processes
ps aux | grep php
```

**Cleanup Failures**
```bash
# Check file permissions
ls -la storage/

# Run with verbose output
php artisan files:cleanup -v

# Check disk space
df -h
```

### Log Files

Monitor these log files for cronjob issues:

- `storage/logs/laravel.log` - Application logs
- `/var/log/cron` - System cron logs
- `storage/logs/scheduler.log` - Laravel scheduler logs

## üìù Command Reference Quick Guide

| Command | Purpose | Frequency | Options |
|---------|---------|-----------|---------|
| `files:cleanup` | Remove expired files | Daily | `--force`, `--dry-run` |
| `upload:cleanup-temp` | Clean temporary files | Twice daily | `--chunks`, `--failed`, `--orphaned` |
| `upload:cleanup-sessions` | Clean expired sessions | Every 6 hours | None |
| `upload:cleanup-all` | Complete cleanup | Weekly | `--force`, `--dry-run` |
| `filehosting:monitor` | Performance monitoring | Hourly | `--cleanup` |
| `filehosting:optimize` | System optimization | Every 4 hours | `--aggressive`, `--dry-run` |
| `maintenance` | Maintenance mode | Manual | `enable`, `disable`, `status` |

---

**Built with Kiro AI** - This comprehensive command system was designed and implemented with Kiro AI assistance to ensure optimal performance and maintenance automation.