# =============================================================================

# Fucking File Hosting - Shared Hosting Optimized .htaccess Configuration

# =============================================================================

# Disable directory browsing and multiviews

Options -Indexes -MultiViews +FollowSymLinks

# =============================================================================

# URL REWRITING AND CLEAN URLS

# =============================================================================

<IfModule mod_rewrite.c>
    RewriteEngine On

    # Handle Authorization Header for API requests
    RewriteCond %{HTTP:Authorization} .
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

    # Force HTTPS (uncomment for production)
    # RewriteCond %{HTTPS} off
    # RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    # Clean URLs for file operations
    # Direct file download: /f/{id} -> /api/download/{id}
    RewriteRule ^f/([a-zA-Z0-9]+)/?$ /api/download/$1 [L,QSA]

    # File preview: /p/{id} -> /api/preview/{id}
    RewriteRule ^p/([a-zA-Z0-9]+)/?$ /api/preview/$1 [L,QSA]

    # File info: /i/{id} -> /file/{id}
    RewriteRule ^i/([a-zA-Z0-9]+)/?$ /file/$1 [L,QSA]

    # Redirect trailing slashes (except for directories)
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} (.+)/$
    RewriteRule ^ %1 [L,R=301]

    # Send all other requests to Laravel front controller
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^ index.php [L]

</IfModule>

# =============================================================================

# SECURITY HEADERS AND PRIVACY PROTECTION

# =============================================================================

<IfModule mod_headers.c>
    # Security headers
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "no-referrer"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=()"

    # Privacy-focused headers (no tracking)
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Header always unset Server
    Header always unset X-Powered-By

    # Enhanced privacy headers
    Header always set X-Privacy-Policy "No personal data collected"
    Header always set X-Data-Retention "Files only, no user data"
    Header always set X-Tracking "None"
    Header always set X-Analytics "Disabled"
    Header always set X-Robots-Tag "noindex, nofollow, noarchive, nosnippet, noimageindex"
    Header always set X-DNS-Prefetch-Control "off"

    # Content Security Policy - Development friendly (Laravel middleware will override this)
    # This is a fallback CSP in case Laravel middleware doesn't run
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' http://localhost:* http://127.0.0.1:*; script-src-elem 'self' 'unsafe-inline' http://localhost:* http://127.0.0.1:*; style-src 'self' 'unsafe-inline' https://fonts.bunny.net; style-src-elem 'self' 'unsafe-inline' https://fonts.bunny.net; img-src 'self' data: blob:; font-src 'self' data: https://fonts.bunny.net; connect-src 'self' ws://localhost:* ws://127.0.0.1:* http://localhost:* http://127.0.0.1:*; media-src 'self' blob:; object-src 'none'; frame-src 'none'; worker-src 'none'; frame-ancestors 'none'; form-action 'self'; base-uri 'self'; manifest-src 'none'"

    # Cross-Origin policies for security
    Header always set Cross-Origin-Embedder-Policy "require-corp"
    Header always set Cross-Origin-Opener-Policy "same-origin"
    Header always set Cross-Origin-Resource-Policy "same-origin"

    # Cache control for static assets
    <FilesMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
        Header set Expires "Thu, 31 Dec 2037 23:55:55 GMT"
    </FilesMatch>

    # No cache for dynamic content
    <FilesMatch "\.(php|html)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>

</IfModule>

# =============================================================================

# PHP CONFIGURATION FOR SHARED HOSTING

# =============================================================================

<IfModule mod_php.c>
    # File upload limits (10GB max)
    php_value upload_max_filesize 10240M
    php_value post_max_size 10240M
    php_value max_file_uploads 100

    # Memory and execution limits
    php_value memory_limit 512M
    php_value max_execution_time 600
    php_value max_input_time 600
    php_value max_input_vars 10000

    # Session configuration
    php_value session.cookie_httponly 1
    php_value session.cookie_secure 1
    php_value session.use_strict_mode 1
    php_value session.cookie_samesite "Strict"

    # Error handling (disable in production)
    php_flag display_errors Off
    php_flag log_errors On
    php_value error_log "error_log"

    # Output buffering for better performance
    php_flag output_buffering On
    php_value output_buffer_size 4096

    # Disable dangerous functions
    php_value disable_functions "exec,passthru,shell_exec,system,proc_open,popen,curl_exec,curl_multi_exec,parse_ini_file,show_source"

</IfModule>

# =============================================================================

# FILE PROTECTION AND ACCESS CONTROL

# =============================================================================

# Protect Laravel configuration files

<Files ".env\*">
Require all denied
</Files>

<Files "composer.\*">
Require all denied
</Files>

<Files "package\*.json">
Require all denied
</Files>

<Files "\*.log">
Require all denied
</Files>

<Files "artisan">
Require all denied
</Files>

# Protect directories

<DirectoryMatch "^._(storage|bootstrap|config|database|resources|routes|tests|vendor)._">
Require all denied
</DirectoryMatch>

# Allow only specific file types for uploads

<LocationMatch "^/api/upload">
<RequireAll>
Require all granted # Add rate limiting if mod_evasive is available
<IfModule mod_evasive24.c>
DOSHashTableSize 2048
DOSPageCount 10
DOSPageInterval 1
DOSSiteCount 50
DOSSiteInterval 1
DOSBlockingPeriod 600
</IfModule>
</RequireAll>
</LocationMatch>

# =============================================================================

# MIME TYPE CONFIGURATION

# =============================================================================

<IfModule mod_mime.c>
    # Ensure proper MIME types for common file formats
    AddType application/javascript .js
    AddType text/css .css
    AddType image/svg+xml .svg
    AddType application/font-woff .woff
    AddType application/font-woff2 .woff2
    AddType application/vnd.ms-fontobject .eot
    AddType application/x-font-ttf .ttf

    # Security: Force download for potentially dangerous files
    <FilesMatch "\.(exe|bat|cmd|com|pif|scr|vbs|js|jar|zip|rar)$">
        Header set Content-Disposition "attachment"
        Header set Content-Type "application/octet-stream"
    </FilesMatch>

</IfModule>

# =============================================================================

# COMPRESSION AND PERFORMANCE

# =============================================================================

<IfModule mod_deflate.c>
    # Enable compression for text-based files
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json

    # Don't compress images and other binary files
    SetEnvIfNoCase Request_URI \
        \.(?:gif|jpe?g|png|zip|gz|bz2|sit|rar|pdf|mov|avi|mp3|mp4|rm)$ no-gzip dont-vary

</IfModule>

# =============================================================================

# ERROR PAGES

# =============================================================================

ErrorDocument 404 /index.php
ErrorDocument 403 /index.php
ErrorDocument 500 /index.php

# =============================================================================

# SHARED HOSTING COMPATIBILITY

# =============================================================================

# Prevent access to version control directories

<DirectoryMatch "^._\.(git|svn|hg|bzr)._">
Require all denied
</DirectoryMatch>

# Prevent access to backup files

<FilesMatch "^.\*\.(bak|backup|old|orig|save|swp|tmp)$">
Require all denied
</FilesMatch>

# Set default charset

AddDefaultCharset UTF-8

# Prevent hotlinking (uncomment and adjust domain for production)

# RewriteCond %{HTTP_REFERER} !^$

# RewriteCond %{HTTP_REFERER} !^https?://(www\.)?yourdomain\.com [NC]

# RewriteRule \.(jpg|jpeg|png|gif|svg|css|js)$ - [F,L]
